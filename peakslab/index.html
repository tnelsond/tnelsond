<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" type="image/png" sizes="32x32" href="favicon32x32.png" />
        <link rel="manifest" href="manifest.json" />
        <title>PS-Khmer Dict 0.3.0</title>
        <link rel="stylesheet" href="chota.css" />
        <style>
            body {
                background-color: #d9d9cf;
            }
            .dropd {
                position: relative;
                display: inline-block;
            }
						.button{
							border: 1px solid grey;
						}
						.media{
							font-size: 50%;
						}
            .context sub{
                color: #664400;
            }
            .context sup{
                color: purple;
            }
            .tbug{
                background: #ffcccc;
                border-radius: 10px;
                padding: 1em;
            }

            .dropd-content {
                display: none;
                position: absolute;
                background-color: #e9d9a9;
                min-width: 160px;
                box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
                padding: 12px 16px;
                z-index: 1;
            }

            .dropd:hover .dropd-content {
                display: block;
            }
            .entry {
                background-color: white;
                border: 2px dashed #deeede;
                border-radius: 5px;
                box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
                margin-bottom: 0.5em;
                padding: 0.5em;
            }
            .hent {
                margin-bottom: 0px;
                margin-top: 0px;
                color: #004400;
            }
            .hentu {
                margin-bottom: 0px;
                margin-top: 0px;
                color: #004400;
								border-bottom: 2px dashed #aaaa99;
								display: inline;
            }
						#logo{
								position: relative;
								z-index: -100;
								font-family: serif;
								font-size: 150%;
						}
            #load {
                border: 16px solid #e3e3d3; /* Light grey */
                border-top: 16px solid #1dda50; /* Blue */
                border-radius: 50%;
                display: inline-block;
                width: 120px;
                height: 120px;
                animation: spin 2s linear infinite;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
						#tout{
							clear:left;
						}
						#q,#searchbutton,#qcol,#qsort{
							background: #f1f1f1;
							margin: 0;
							padding: 0;
							border: 0;
							font-size: 100%;
							font: inherit;
							vertical-align: baseline;
							padding: 10px;
							border: 1px solid grey;
							font-size: 17px;
						}
						#q{
							background: #f1f1f1;
							border-right: none;
							border-left: none;
							border-radius: 0px;
							float: left;
							width: calc(100% - 9.5em);
						}
						#qcol{
							border-right: 1px solid grey;
							border-radius: 15px 0px 0px 15px;
							float: left;
							width: 4em;
							background: #cccccc;
							padding: 11px 1px 12px 5px;
							font-size: 15px;
							text-align: center;
						}
						#qsort{
							float: left;
							width: 1.5em;
							padding-left: 0px;
							border-right: none;
							border-left: none;
							border-radius: 0px;
						}
						#qsort:hover{
							color: red;
						}
						.searchbox{
							margin-top: 1em;
							clear: left;
							float: left;
							width: 100%;
						}
						#searchbutton{
							padding: 10px;
							border: 1px solid grey;
							font-size: 17px;
							border-left: none;
							border-radius: 0px 15px 15px 0px;
							cursor: pointer;
							float: left;
							width: 4em;
							background: #229922;
						}
						#searchbutton:hover{
							background: #44aa44;
						}
						@-moz-document url-prefix() {
							#qcol{
								padding: 12px 1px 12px 5px;
							}
							#searchbutton{
								padding-bottom: 11px;
							}
						}
        </style>
    </head>
    <body>
        <main class="container">
            <div id="load"></div>
												<div id="logo"><img src="peakslab.svg" alt="Peak Slab" style="padding: .5em; float: left" width="100px"></div>
                        <select style="float: left; width: 6em; margin-right: .4em" name="tablesel" id="tablesel" onchange="javascript:tInit(this)"> </select>
                        <div class="dropd">
                            <span class="button dark" style="padding-left: .9em; padding-right: .9em;">Columns</span>
                            <div id="dcol" class="dropd-content"></div>
                        </div>
                        <div class="dropd">
                            <span class="button" style="padding-left: .9em; padding-right: .9em">Options</span>
                            <div class="dropd-content">
                                <input type="checkbox" id="bcheck" value="b" checked /><label>Beginning</label><br>
                                <input type="checkbox" id="echeck" value="e" /><label>Ending</label><br>
                                <label for="limit"> <input type="range" min="5" max="1000" value="50" class="slider" id="limit" /> Results <span id="limitd">50</span></label>
                            </div>
                        </div>
												<div class="searchbox">
												<select name="qcol" id="qcol"> </select>
                        <input type="search" id="q" name="search" placeholder="Search..." onsearch="javascript:tSearch(0)" autofocus>
												<div id="qsort" onclick="tToggleDesc(this)">A‚Üì</div>
                        <button id="searchbutton" onclick="javascript:tSearch(0)">üîç</button>
												</div>
            <div id="tresults"></div>
            <div id="tout"></div>
            <script>
								const logo = document.getElementById("logo");
								logo.innerHTML = document.title + logo.innerHTML;
                const q = document.getElementById("q");
                q.addEventListener("keypress", function (event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        tSearch(0);
                    }
                });

                var desc = true;
								var tToggleDesc = function (div) {
										desc = !desc;
										if(desc){
											div.innerHTML = "A‚Üì";
										}
										else{
											div.innerHTML = "A‚Üë";
										}
										tSearch(0);
								};

                const tsel = document.getElementById("tablesel");
                const qcol = document.getElementById("qcol");
                const limitd = document.getElementById("limitd");
                const limit = document.getElementById("limit");
								const tout = document.getElementById("tout");
								const tresults = document.getElementById("tresults");
								var trestotal = 0;
								var fullsearch = 0;
                limit.oninput = function () {
                    limitd.innerHTML = this.value;
                };
								const tlist = [];
                const bcheck = document.getElementById("bcheck");
                const echeck = document.getElementById("echeck");
                const dcol = document.getElementById("dcol");
                const w = new Worker(
                    "dict.js?sqlite3.dir=jswasm&" // + urlParams
                    /* Note the URL argument on that name. See
                              the notes in demo-123.js (search for
                              "importScripts") for why we need
                              that. */
                );
                (function () {
                    var color = false;
                    const logHtml = function (cssClass, ...args) {
                        if (cssClass == "entry") {
                            const ln = document.createElement("div");
                            ln.classList.add("entry");
                            ln.innerHTML = args;
                            //        ln.append(document.createTextNode(args.join(' ')));
                            tout.append(ln);
                            color = !color;
                        } else if (cssClass == "results") {
													trestotal += args;
													tresults.innerHTML += (args == '0' ? '<span class="bd-error">' : '<span class="bd-success">') + args + ", </span>";
													if(fullsearch == 0 && trestotal == 0){
														tSearch(1);
													}
                        } else if (cssClass == "refresh") {
                            tInit();
                        } else if (cssClass == "init") {
														if(args == "*ALL"){
															qcol.innerHTML += '<option style="background: yellow; font-size: 125%" value="' + args + '">' + args + "</option>";
														}else{
															qcol.innerHTML += '<option value="' + args + '">' + args + "</option>";
															dcol.innerHTML += '<input type="checkbox" value="' + args + '" checked><label>' + args + "</label><br>";
														}
														let lo = document.getElementById("load");
														if (lo) lo.remove();
                        } else if (cssClass == "init2") {
														tlist[tlist.length-1].col.push(args);
                        } else if (cssClass == "dictlist") {
														/*tlist = [{name: "khmer7", col: ["kh", "csea", "headley97", "misc"]}, {name: "xEng", col: ["w", "def", "m"]}];*/
														tlist.push({name: args, col: []})
                            tsel.innerHTML += '<option value="' + args + '">' + args + "</option>";
                        } else if (cssClass == "audio") {
														(async () => {
															const blob = new Blob([args[1]], { type: 'audio/webm; codecs=opus' })
															const audio = new Audio(URL.createObjectURL(blob));
															audio.controls = true;
															audio.autoplay = true;
															const media = document.getElementById(args[0]);
															media.innerHTML = "";
															media.appendChild(audio);
														})()
                        } else {
                            const ln = document.createElement("div");
                            if (cssClass) ln.classList.add(cssClass);
                            ln.append(document.createTextNode(args.join(" ")));
                            document.getElementById("tbug").append(ln);
                        }
                    };

                    //const urlParams = new URL(globalThis.location.href).searchParams;
                    //document.getElementById('input').value = urlParams.get("search");

                    w.onmessage = function ({ data }) {
                        console.log("MAIN: Message received from worker");
                        switch (data.type) {
                            case "log":
                                logHtml(data.payload.cssClass, ...data.payload.args);
                                break;
                            default:
                                logHtml("bg-error", "Unhandled message:", data.type);
                        }
                    };
                })();
								var tAudio = function (button) {
                    console.log("MAIN: request audio message sent to worker");
										let id = button.parentNode.id;
                    w.postMessage(".addmedia: " + id + "@" + id);
								};
                var tInit = function () {
                    console.log("MAIN: init message sent to worker");
                    dcol.innerHTML = qcol.innerHTML = "";
										if(tlist.length > 0){
											const foundIdx = tlist.findIndex(el => el.name == tsel.value);
											const temp = tlist[foundIdx];
											tlist.splice(foundIdx, 1);
											tlist.unshift(temp);
											tsel.innerHTML = "";
											tlist.forEach(tl => tsel.innerHTML += '<option value="' + tl.name + '">' + tl.name + "</option>");
										}
                    w.postMessage(".init: " + tsel.value);
                };

                var tSearch = function (all) {
                    console.log("MAIN: Message posted to worker");
										const q2 = q.value.replaceAll(/[']+/g, "‚Äò")
                    tout.innerHTML = "";
										tresults.innerHTML = "Results: ";
										trestotal = 0;
										fullsearch = all;
										if(all == 0 && qcol.value != "*ALL"){
											const dlist = [];
											dcol.childNodes.forEach(function (node) {
													if (node.tagName == "INPUT" && node.checked) {
															dlist.push(node.value);
													}
											});
											const dres = dlist.filter((x) => typeof x === "string" && x.length > 0).join(", ");
											w.postMessage(
													"SELECT " +
															dres +
															" FROM " +
															tsel.value +
															" WHERE " +
															qcol.value +
															" LIKE " +
															(!bcheck.checked ? "'%" : "'") +
															q2 +
															(!echeck.checked ? "%'" : "'") +
															" order by " +
															qcol.value +
															(desc ? " desc" : " asc") +
															" limit " +
															limit.value +
															";"
											);
									}else{
										/*tlist = [{name: "khmer7", col: ["kh", "csea", "headley97", "misc"]}, {name: "xEng", col: ["w", "def", "m"]}];*/
										tlist.forEach(function tcallall(ctab){
										/*	for (let i = 0; i < ctab.col.length; i++) {
												let ccol = ctab.col[i]; */
											let ccol = ctab.col.join(" LIKE '%" + q2 + "%' OR ") + " LIKE '%" + q2 + "%'";
											w.postMessage("SELECT " + ctab.col.join(", ") + " FROM " + ctab.name + " WHERE " + ccol + " order by " + ((ctab.name == tsel.value && qcol.value != "*ALL") ? qcol.value : ctab.col[0]) + (desc ? " desc" : " asc") + " limit " + limit.value + ";");
										});
									}
                };

                const registerServiceWorker = async () => {
                    if ("serviceWorker" in navigator) {
                        try {
                            const registration = await navigator.serviceWorker.register("dictsw.js", {});
                            if (registration.installing) {
                                console.log("Service worker installing");
                            } else if (registration.waiting) {
                                console.log("Service worker installed");
                            } else if (registration.active) {
                                console.log("Service worker active");
                            }
                        } catch (error) {
                            console.error(`Registration failed with ${error}`);
                        }
                    }
                };
                registerServiceWorker();

                var tRemoveServiceWorker = function () {
                    console.log("Trying to uninstall Service Worker");
                    if (window.navigator && navigator.serviceWorker) {
                        navigator.serviceWorker.getRegistrations().then(function (registrations) {
                            for (let registration of registrations) {
                                registration.unregister();
                                console.log("Uninstalled Service Worker");
                            }
                        });
                    }
                };
            </script>
            <div id="tbug" class="tbug"></div>
            <button class="button error" onclick="javascript:tRemoveServiceWorker(this)">Uninstall</button>
        </main>
    </body>
</html>
